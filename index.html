<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Smart Bed - Professional Firebase System</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --path-color: #000000; --floor: #f4f7f6; --wall: #2c3e50; --room-bg: #fff9db; }
        body { font-family: 'Prompt', sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .map { width: 1150px; height: 720px; background: var(--floor); position: relative; border: 10px solid var(--wall); border-radius: 8px; }
        
        /* --- ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏≤‡∏à‡∏£ --- */
        .path { position: absolute; background: var(--path-color); z-index: 1; }
        .v-main { width: 6px; height: 100%; left: 280px; top: 0; } 
        .h-mid { width: 800px; height: 6px; left: 280px; top: 320px; } 
        .st-exit-v { width: 6px; height: 100px; left: 80px; top: 150px; } 
        .st-exit-h { width: 200px; height: 6px; left: 80px; top: 250px; }
        .conn-room { height: 4px; width: 130px; left: 150px; top: 480px; } 

        /* --- ‡∏ã‡∏≠‡∏á‡∏à‡∏≠‡∏î (Slots) --- */
        .bed-station { position: absolute; width: 180px; height: 150px; background: white; border: 4px solid var(--wall); left: 10px; top: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: black; z-index: 2; }
        .room { position: absolute; width: 140px; height: 160px; background: var(--room-bg); border: 3px solid #f1c40f; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #916110; border-radius: 5px; z-index: 2; left: 10px; top: 400px; }
        
        .slot { position: absolute; width: 100px; height: 140px; border: 3px solid #2ecc71; background: rgba(46, 204, 113, 0.1); border-radius: 8px; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #27ae60; transition: all 0.5s; }
        .slot.occupied { border-color: #e74c3c; background: rgba(231, 76, 60, 0.2); color: #c0392b; }

        /* --- ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á --- */
        .bed { width: 45px; height: 75px; position: absolute; border-radius: 6px; z-index: 10; transition: all 1s linear; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .panel { background: #2d3436; padding: 20px; border-radius: 12px; display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end; }
        select, button { padding: 10px; border-radius: 5px; border: none; font-family: 'Prompt'; font-weight: bold; }
        button { background: #00b894; color: white; cursor: pointer; }
        .status-sync { font-size: 12px; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="panel">
        <div><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏µ‡∏¢‡∏á:</label><br><select id="bedSelect"><option value="bed01">BED-01</option><option value="bed02">BED-02</option><option value="bed03">BED-03</option></select></div>
        <div><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</label><br><select id="destLoc">
            <option value="room101">‡πÑ‡∏õ Room 101</option>
            <option value="A1">‡πÑ‡∏õ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á A1</option><option value="A2">‡πÑ‡∏õ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á A2</option>
            <option value="A4">‡πÑ‡∏õ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á A4</option><option value="A5">‡πÑ‡∏õ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á A5</option>
            <option value="station">‡∏Å‡∏•‡∏±‡∏ö Bed Station</option>
        </select></div>
        <button onclick="executePath()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
    </div>
    <div class="status-sync">Firebase Status: <span id="db-status">Connecting...</span></div>

    <div class="map">
        <div class="bed-station">Bed Station</div>
        <div id="slotroom101" class="room">Room 101</div>
        <div id="slotA4" class="slot" style="left: 400px; top: 40px;">A4</div>
        <div id="slotA5" class="slot" style="left: 650px; top: 40px;">A5</div>
        <div id="slotA1" class="slot" style="left: 400px; top: 450px;">A1</div>
        <div id="slotA2" class="slot" style="left: 650px; top: 450px;">A2</div>

        <div class="path v-main"></div><div class="path h-mid"></div>
        <div class="path st-exit-v"></div><div class="path st-exit-h"></div>
        <div class="path conn-room"></div>

        <div id="bed01" class="bed" style="background: #0984e3; left: 20px; top: 25px;">B1</div>
        <div id="bed02" class="bed" style="background: #6c5ce7; left: 75px; top: 25px;">B2</div>
        <div id="bed03" class="bed" style="background: #e84393; left: 130px; top: 25px;">B3</div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDn5cYoLlkSXDVKVjrkOotSAOgktPTy9x8",
            authDomain: "smartbed-project-ba5e4.firebaseapp.com",
            databaseURL: "https://smartbed-project-ba5e4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smartbed-project-ba5e4",
            storageBucket: "smartbed-project-ba5e4.firebasestorage.app",
            messagingSenderId: "727608152921",
            appId: "1:727608152921:web:bab20a0ee4231b18c83248",
            measurementId: "G-BMF0X48R23"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        document.getElementById('db-status').innerText = "Connected ‚úÖ";

        const homeX = { 'bed01': 20, 'bed02': 75, 'bed03': 130 };
        const slotConfig = { 
            A1: { x: 450, y: 480, isBottom: true },
            A2: { x: 700, y: 480, isBottom: true },
            A4: { x: 450, y: 100, isBottom: false },
            A5: { x: 700, y: 100, isBottom: false }
        };

        let currentStatus = { 'bed01': 'station', 'bed02': 'station', 'bed03': 'station' };
        let slotOccupancy = { A1: false, A2: false, A4: false, A5: false, room101: false };

        // --- Firebase Listener: ‡∏Ñ‡∏≠‡∏¢‡∏ü‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡πá‡∏° ---
        db.ref('slots').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                slotOccupancy = data;
                Object.keys(data).forEach(loc => updateSlotUI(loc, data[loc]));
            }
        });

        async function executePath() {
            const id = document.getElementById('bedSelect').value;
            const start = currentStatus[id];
            const dest = document.getElementById('destLoc').value;

            if (start === dest) return;
            if (dest !== 'station' && slotOccupancy[dest]) {
                alert(`‚ùå ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${dest} ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á!`);
                return;
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firebase: ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤
            if (start !== 'station') db.ref(`slots/${start}`).set(false);

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô 360)
            if (start.startsWith('A')) {
                await exitFromSlotToMain(id, start);
                if (dest === 'room101') await fromMainToRoom(id);
                else if (dest === 'station') await fromMainToStation(id);
            } else if (start === 'station') {
                if (dest === 'room101') await stationToRoom(id);
                else if (dest.startsWith('A')) await stationToSlots(id, dest);
            } else if (start === 'room101') {
                if (dest === 'station') await roomToStation(id);
                else if (dest.startsWith('A')) await roomToSlots(id, dest);
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Firebase: ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
            currentStatus[id] = dest;
            if (dest !== 'station') db.ref(`slots/${dest}`).set(true);
        }

        function updateSlotUI(loc, occupied) {
            const el = document.getElementById('slot' + loc);
            if (el) occupied ? el.classList.add('occupied') : el.classList.remove('occupied');
        }

        function move(id, x, y, deg) {
            return new Promise(resolve => {
                const el = document.getElementById(id);
                el.style.transform = `rotate(${deg}deg)`;
                setTimeout(() => {
                    el.style.left = x + 'px'; el.style.top = y + 'px';
                    setTimeout(resolve, 1200);
                }, 400);
            });
        }

        // --- Navigation Logic (No Spin 360) ---
        async function exitFromSlotToMain(id, slot) {
            const conf = slotConfig[slot];
            await move(id, conf.x, (conf.isBottom ? 480 : 100), 90); 
            await move(id, conf.x, 320, 0);   
            await move(id, 258, 320, -90);   
        }

        async function fromMainToRoom(id) {
            await move(id, 258, 480, -180); 
            await move(id, 55, 480, -270); 
        }

        async function fromMainToStation(id) {
            await move(id, 258, 212, 0); 
            await move(id, 80, 212, -90); 
            await move(id, homeX[id], 25, 0);
        }

        async function stationToRoom(id) {
            await move(id, homeX[id], 212, 180); 
            await move(id, 258, 212, 90); 
            await move(id, 258, 480, 180); 
            await move(id, 55, 480, 270); 
        }

        async function roomToStation(id) {
            await move(id, 258, 480, 90); 
            await move(id, 258, 212, 0); 
            await move(id, 80, 212, -90); 
            await move(id, homeX[id], 25, 0);
        }

        async function stationToSlots(id, slot) {
            const conf = slotConfig[slot];
            await move(id, homeX[id], 212, 180); 
            await move(id, 258, 212, 90); 
            await move(id, 258, 320, 180); 
            await move(id, conf.x, 320, 90); 
            if(conf.isBottom) { await move(id, conf.x, 480, 180); await move(id, conf.x-50, 480, 270); }
            else { await move(id, conf.x, 100, 0); await move(id, conf.x-50, 100, -90); }
        }

        async function roomToSlots(id, slot) {
            const conf = slotConfig[slot];
            await move(id, 258, 480, 90); 
            await move(id, 258, 320, 0); 
            await move(id, conf.x, 320, 90); 
            if(conf.isBottom) { await move(id, conf.x, 480, 180); await move(id, conf.x-50, 480, 270); }
            else { await move(id, conf.x, 100, 0); await move(id, conf.x-50, 100, -90); }
        }
    </script>
</body>
</html>