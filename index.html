<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bed AGV - Ultimate System</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root { --path-color: #000; --floor: #f4f7f6; --wall: #2c3e50; --success: #00b894; --danger: #d63031; --warning: #f1c40f; }
        body { font-family: 'Prompt', sans-serif; background: #1a1a1a; color: #eee; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* Login UI */
        #authOverlay { position: fixed; inset: 0; background: #1a1a1a; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: #2d3436; padding: 40px; border-radius: 15px; width: 320px; text-align: center; border: 1px solid #444; }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #1e272e; color: white; box-sizing: border-box; }
        
        /* Layout */
        .ui-container { display: flex; gap: 15px; width: 1150px; margin-bottom: 15px; }
        .panel { background: #2d3436; padding: 15px; border-radius: 12px; flex: 1; border: 1px solid #3d3d3d; }
        
        /* Map & Elements */
        .map { width: 1150px; height: 650px; background: var(--floor); position: relative; border: 10px solid var(--wall); border-radius: 8px; overflow: hidden; }
        .path { position: absolute; background: var(--path-color); z-index: 1; }
        .v-main { width: 6px; height: 100%; left: 280px; top: 0; } 
        .h-mid { width: 800px; height: 6px; left: 280px; top: 320px; } 
        .st-exit-v { width: 6px; height: 100px; left: 80px; top: 150px; } 
        .st-exit-h { width: 200px; height: 6px; left: 80px; top: 250px; }
        .conn-room { height: 4px; width: 130px; left: 150px; top: 480px; } 

        .bed-station { position: absolute; width: 180px; height: 150px; background: white; border: 4px solid var(--wall); left: 10px; top: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: black; z-index: 2; }
        .room { position: absolute; width: 140px; height: 160px; background: #fff9db; border: 3px solid #f1c40f; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #916110; left: 10px; top: 400px; z-index: 2; }
        
        .slot { position: absolute; width: 100px; height: 130px; border: 3px solid var(--success); background: rgba(0, 184, 148, 0.1); border-radius: 8px; z-index: 2; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--success); }
        .slot.occupied { border-color: var(--danger); background: rgba(214, 48, 49, 0.2); color: var(--danger); }

        .bed { width: 42px; height: 72px; position: absolute; border-radius: 5px; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; transition: left 1.5s linear, top 1.5s linear, transform 0.6s ease-in-out; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* Helpers */
        .log-panel { height: 120px; overflow-y: auto; background: #1e272e; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        .online-tag { display: flex; align-items: center; font-size: 0.8rem; margin-bottom: 4px; }
        .dot { height: 8px; width: 8px; background: var(--success); border-radius: 50%; margin-right: 8px; }
        button { cursor: pointer; border: none; border-radius: 6px; font-family: 'Prompt'; font-weight: bold; }
        .btn-go { background: var(--success); color: white; width: 100%; padding: 10px; }
        .btn-reset { background: #e67e22; color: white; width: 100%; padding: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-card">
            <h2 id="authTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</h2>
            <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-go" onclick="handleAuth()">‡∏ï‡∏Å‡∏•‡∏á</button>
            <p id="toggleMsg" onclick="toggleAuthMode()" style="cursor:pointer; font-size:0.8rem; margin-top:15px; color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
        </div>
    </div>

    <div class="ui-container">
        <div class="panel" style="max-width: 220px; text-align: center;">
            <div id="clock" style="font-size: 1.8rem; color: var(--success); font-weight: bold;">00:00:00</div>
            <div id="date" style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">--/--/--</div>
            <div id="userEmail" style="font-size: 0.75rem; color: #00cec9; margin-bottom: 10px;">--</div>
            <button onclick="firebase.auth().signOut()" style="background:none; color:#ff7675; border:1px solid #ff7675; font-size:0.7rem; padding:2px 10px;">Logout</button>
        </div>

        <div class="panel">
            <h3>ü§ñ ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</h3>
            <div style="display: flex; gap: 10px;">
                <select id="bedSelect" style="flex:1; padding: 8px; border-radius: 5px;"><option value="bed01">BED-01</option><option value="bed02">BED-02</option><option value="bed03">BED-03</option></select>
                <select id="destLoc" style="flex:1; padding: 8px; border-radius: 5px;">
                    <option value="A1">Slot A1</option><option value="A2">Slot A2</option>
                    <option value="A4">Slot A4</option><option value="A5">Slot A5</option>
                    <option value="room101">Room 101</option><option value="station">Station</option>
                </select>
            </div>
            <button class="btn-go" onclick="executePath()" style="margin-top: 10px;">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà</button>
            <button class="btn-reset" onclick="resetAllBeds()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="panel">
            <h3>üë• ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
            <div id="onlineUsers" style="max-height: 80px; overflow-y: auto;"></div>
            <h3 style="margin-top: 10px;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <div id="activityLog" class="log-panel"></div>
        </div>
    </div>

    <div class="map">
        <div class="bed-station">Station</div>
        <div id="slotroom101" class="room">Room 101</div>
        <div id="slotA4" class="slot" style="left: 400px; top: 40px;">A4</div>
        <div id="slotA5" class="slot" style="left: 650px; top: 40px;">A5</div>
        <div id="slotA1" class="slot" style="left: 400px; top: 460px;">A1</div>
        <div id="slotA2" class="slot" style="left: 650px; top: 460px;">A2</div>

        <div class="path v-main"></div><div class="path h-mid"></div>
        <div class="path st-exit-v"></div><div class="path st-exit-h"></div><div class="path conn-room"></div>

        <div id="bed01" class="bed" style="background: #0984e3;">B1</div>
        <div id="bed02" class="bed" style="background: #6c5ce7;">B2</div>
        <div id="bed03" class="bed" style="background: #e84393;">B3</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDn5cYoLlkSXDVKVjrkOotSAOgktPTy9x8",
            authDomain: "smartbed-project-ba5e4.firebaseapp.com",
            databaseURL: "https://smartbed-project-ba5e4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smartbed-project-ba5e4",
            appId: "1:727608152921:web:bab20a0ee4231b18c83248"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let isSignUpMode = false;
        let currentPos = { bed01:{x:30,y:40,d:0}, bed02:{x:85,y:40,d:0}, bed03:{x:140,y:40,d:0} };
        let currentStatus = { bed01:'station', bed02:'station', bed03:'station' };
        let slotOccupancy = { A1:false, A2:false, A4:false, A5:false, room101:false };

        // --- AUTH & ONLINE STATUS ---
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('authTitle').innerText = isSignUpMode ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            document.getElementById('toggleMsg').innerText = isSignUpMode ? "‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        }

        function handleAuth() {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            if(!email || !pw) return;
            isSignUpMode ? auth.createUserWithEmailAndPassword(email, pw) : auth.signInWithEmailAndPassword(email, pw);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('userEmail').innerText = user.email;
                setupPresence(user);
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
            }
        });

        function setupPresence(user) {
            const myStatusRef = db.ref('/presence/' + user.uid);
            db.ref('.info/connected').on('value', snap => {
                if (snap.val() === false) return;
                myStatusRef.onDisconnect().remove();
                myStatusRef.set({ email: user.email, time: firebase.database.ServerValue.TIMESTAMP });
            });
        }

        db.ref('/presence').on('value', snap => {
            const div = document.getElementById('onlineUsers');
            div.innerHTML = "";
            if(snap.val()) Object.values(snap.val()).forEach(u => {
                div.innerHTML += `<div class="online-tag"><span class="dot"></span> ${u.email}</div>`;
            });
        });

        // --- REAL-TIME DATA SYNC ---
        db.ref('beds').on('value', snap => {
            const data = snap.val();
            if(data) Object.keys(data).forEach(id => {
                currentPos[id] = data[id];
                const el = document.getElementById(id);
                el.style.left = data[id].x + 'px'; el.style.top = data[id].y + 'px';
                el.style.transform = `rotate(${data[id].d}deg)`;
            });
        });

        db.ref('commands/bedStatus').on('value', snap => { if(snap.val()) currentStatus = snap.val(); });

        db.ref('fleet').on('value', snap => {
            slotOccupancy = snap.val() || {};
            Object.keys(slotOccupancy).forEach(s => {
                const el = document.getElementById('slot'+s);
                if(el) slotOccupancy[s] ? el.classList.add('occupied') : el.classList.remove('occupied');
            });
        });

        // --- AGV PRECISION MOVE ---
        async function move(id, x, y, newDeg) {
            // ‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô (0.6s)
            if (currentPos[id].d !== newDeg) {
                await db.ref(`beds/${id}`).update({ d: newDeg });
                await new Promise(r => setTimeout(r, 650));
            }
            // ‡πÄ‡∏î‡∏¥‡∏ô (1.5s)
            await db.ref(`beds/${id}`).update({ x, y });
            await new Promise(r => setTimeout(r, 1600));
        }

        async function executePath() {
            const id = document.getElementById('bedSelect').value;
            const dest = document.getElementById('destLoc').value;
            const start = currentStatus[id] || 'station';

            if (start === dest) return alert("‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
            if (dest !== 'station' && slotOccupancy[dest]) return alert("‡∏ã‡∏≠‡∏á‡∏à‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á");

            addLog(`üöÄ ${id}: ${start} -> ${dest}`);
            if (start !== 'station') db.ref(`fleet/${start}`).set(false);

            const MV = 258, MH = 320, sX = { A1:425, A2:675, A4:425, A5:675 };

            if (dest !== 'station') {
                await move(id, currentPos[id].x, 215, 180);
                await move(id, MV, 215, 90);
                if (dest === 'room101') {
                    await move(id, MV, 445, 180); await move(id, 55, 445, 270);
                } else {
                    await move(id, MV, MH, 180); await move(id, sX[dest], MH, 90);
                    dest === 'A1' || dest === 'A2' ? await move(id, sX[dest], 460, 180) : await move(id, sX[dest], 100, 0);
                }
            } else {
                if (start === 'room101') await move(id, MV, 445, 90);
                else {
                    await move(id, sX[start], MH, (start.endsWith('1')||start.endsWith('2'))?0:180);
                    await move(id, MV, MH, 270);
                }
                await move(id, MV, 215, 0); await move(id, 80, 215, 270);
                const hX = id==='bed01'?30:id==='bed02'?85:140; await move(id, hX, 40, 0);
            }

            currentStatus[id] = dest;
            db.ref('commands/bedStatus').update({ [id]: dest });
            if (dest !== 'station') db.ref(`fleet/${dest}`).set(true);
            addLog(`üìç ${id} ‡∏ñ‡∏∂‡∏á ${dest}`);
        }

        async function resetAllBeds() {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
            await db.ref('beds').set({ bed01:{x:30,y:40,d:0}, bed02:{x:85,y:40,d:0}, bed03:{x:140,y:40,d:0} });
            await db.ref('commands/bedStatus').set({ bed01:'station', bed02:'station', bed03:'station' });
            await db.ref('fleet').set({ A1:false, A2:false, A4:false, A5:false, room101:false });
            addLog("üîÑ SYSTEM RESET BY ADMIN");
        }

        // Utils
        function addLog(msg) { db.ref('logs').push({ time: new Date().toLocaleTimeString('th-TH'), msg }); }
        db.ref('logs').limitToLast(10).on('value', snap => {
            const div = document.getElementById('activityLog'); div.innerHTML = "";
            if(snap.val()) Object.values(snap.val()).reverse().forEach(l => div.innerHTML += `<div>[${l.time}] ${l.msg}</div>`);
        });
        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.toLocaleTimeString('th-TH');
            document.getElementById('date').innerText = d.toLocaleDateString('th-TH');
        }, 1000);
    </script>
</body>
</html>