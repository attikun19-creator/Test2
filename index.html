<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Smart Bed - Final Sync System</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --path-color: #000000; --floor: #f4f7f6; --wall: #2c3e50; --room-bg: #fff9db; --danger: #d63031; --success: #00b894; }
        body { font-family: 'Prompt', sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .ui-container { display: flex; gap: 15px; width: 1170px; margin-bottom: 20px; }
        .panel { background: #2d3436; padding: 20px; border-radius: 12px; flex: 1; }
        .log-panel { height: 150px; overflow-y: auto; background: #1e272e; padding: 10px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #3d3d3d; }
        .map { width: 1150px; height: 720px; background: var(--floor); position: relative; border: 10px solid var(--wall); border-radius: 8px; }
        .bed { width: 45px; height: 75px; position: absolute; border-radius: 6px; z-index: 10; transition: all 1s linear; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .slot { position: absolute; width: 100px; height: 140px; border: 3px solid var(--success); background: rgba(0, 184, 148, 0.1); border-radius: 8px; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: var(--success); transition: all 0.5s; }
        .slot.occupied { border-color: var(--danger); background: rgba(214, 48, 49, 0.2); color: var(--danger); }
        .path { position: absolute; background: var(--path-color); z-index: 1; }
        .v-main { width: 6px; height: 100%; left: 280px; top: 0; } 
        .h-mid { width: 800px; height: 6px; left: 280px; top: 320px; } 
        .st-exit-v { width: 6px; height: 100px; left: 80px; top: 150px; } 
        .st-exit-h { width: 200px; height: 6px; left: 80px; top: 250px; }
        .conn-room { height: 4px; width: 130px; left: 150px; top: 480px; } 
        .bed-station { position: absolute; width: 180px; height: 150px; background: white; border: 4px solid var(--wall); left: 10px; top: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: black; z-index: 2; }
        .room { position: absolute; width: 140px; height: 160px; background: var(--room-bg); border: 3px solid #f1c40f; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #916110; border-radius: 5px; z-index: 2; left: 10px; top: 400px; }
        select, button { padding: 10px; border-radius: 5px; border: none; font-family: 'Prompt'; font-weight: bold; margin: 5px; }
        button { cursor: pointer; }
        .btn-start { background: var(--success); color: white; width: 100%; }
        .btn-stop { background: var(--danger); color: white; width: 100%; }
        .btn-reset { background: #e67e22; color: white; width: 100%; }
    </style>
</head>
<body>

    <div class="ui-container">
        <div class="panel" style="text-align: center; background: #000; max-width: 200px;">
            <div id="clock" style="font-size: 1.8rem; font-weight: bold; color: var(--success);">00:00:00</div>
            <div id="date" style="font-size: 0.8rem; color: #888;">-- / -- / ----</div>
            <button class="btn-reset" onclick="resetAllBeds()">üîÑ RESET ALL</button>
        </div>

        <div class="panel">
            <h3>ü§ñ Auto Control</h3>
            <select id="bedSelect"><option value="bed01">BED-01</option><option value="bed02">BED-02</option><option value="bed03">BED-03</option></select>
            <select id="destLoc">
                <option value="room101">Room 101</option>
                <option value="A1">Slot A1</option><option value="A2">Slot A2</option>
                <option value="A4">Slot A4</option><option value="A5">Slot A5</option>
                <option value="station">Station</option>
            </select>
            <button class="btn-start" onclick="executePath()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            <button class="btn-stop" id="stopBtn" onclick="toggleEmergency()">üö® STOP</button>
        </div>

        <div class="panel">
            <h3>üìù Activity Log</h3>
            <div id="activityLog" class="log-panel"></div>
        </div>
    </div>

    <div class="map">
        <div class="bed-station">Bed Station</div>
        <div id="slotroom101" class="room">Room 101</div>
        <div id="slotA4" class="slot" style="left: 400px; top: 40px;">A4</div>
        <div id="slotA5" class="slot" style="left: 650px; top: 40px;">A5</div>
        <div id="slotA1" class="slot" style="left: 400px; top: 450px;">A1</div>
        <div id="slotA2" class="slot" style="left: 650px; top: 450px;">A2</div>
        <div class="path v-main"></div><div class="path h-mid"></div><div class="path st-exit-v"></div><div class="path st-exit-h"></div><div class="path conn-room"></div>
        <div id="bed01" class="bed" style="background: #0984e3; left: 20px; top: 25px;">B1</div>
        <div id="bed02" class="bed" style="background: #6c5ce7; left: 75px; top: 25px;">B2</div>
        <div id="bed03" class="bed" style="background: #e84393; left: 130px; top: 25px;">B3</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDn5cYoLlkSXDVKVjrkOotSAOgktPTy9x8",
            authDomain: "smartbed-project-ba5e4.firebaseapp.com",
            databaseURL: "https://smartbed-project-ba5e4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smartbed-project-ba5e4",
            appId: "1:727608152921:web:bab20a0ee4231b18c83248"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let isEmergency = false;
        let currentPos = { bed01:{x:20,y:25,d:0}, bed02:{x:75,y:25,d:0}, bed03:{x:130,y:25,d:0} };
        let currentStatus = { bed01:'station', bed02:'station', bed03:'station' };
        let slotOccupancy = { A1:false, A2:false, A4:false, A5:false, room101:false };

        // --- 1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ (Sync Listeners) ---
        
        // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Firebase (‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ commands ‡πÉ‡∏ô‡∏£‡∏π‡∏õ)
        db.ref('commands/bedStatus').on('value', (snap) => {
            const status = snap.val();
            if (status && typeof status === 'object') currentStatus = status;
        });

        // ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å Firebase (‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ beds ‡πÉ‡∏ô‡∏£‡∏π‡∏õ)
        db.ref('beds').on('value', (snap) => {
            const data = snap.val();
            if (data) {
                Object.keys(data).forEach(id => {
                    if (data[id].x !== undefined) {
                        currentPos[id] = data[id];
                        updateBedUI(id);
                    }
                });
            }
        });

        // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏õ‡∏∏‡πà‡∏° STOP
        db.ref('commands/emergency').on('value', (snap) => {
            isEmergency = snap.val();
            const btn = document.getElementById('stopBtn');
            btn.innerText = isEmergency ? "‚ö° RESET" : "üö® STOP";
            btn.style.background = isEmergency ? "#f1c40f" : "var(--danger)";
        });

        // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≠‡∏î
        db.ref('fleet').on('value', (snap) => {
            const data = snap.val() || {};
            slotOccupancy = data;
            Object.keys(slotOccupancy).forEach(loc => {
                const el = document.getElementById('slot' + loc);
                if (el) data[loc] ? el.classList.add('occupied') : el.classList.remove('occupied');
            });
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ---
        db.ref('logs').limitToLast(10).on('value', (snap) => {
            const logs = snap.val();
            const logDiv = document.getElementById('activityLog');
            logDiv.innerHTML = "";
            if (logs) Object.values(logs).reverse().forEach(l => {
                logDiv.innerHTML += `<div><span style="color:var(--success)">[${l.time}]</span> ${l.msg}</div>`;
            });
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('th-TH', { hour12: false });
            document.getElementById('date').innerText = now.toLocaleDateString('th-TH');
        }
        setInterval(updateClock, 1000);

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å ---
        function addLog(msg) {
            const time = new Date().toLocaleTimeString('th-TH', { hour12: false });
            db.ref('logs').push({ time, msg });
        }

        function toggleEmergency() {
            isEmergency = !isEmergency;
            db.ref('commands/emergency').set(isEmergency);
            addLog(isEmergency ? "üõë EMERGENCY STOP" : "‚úÖ READY");
        }

        async function resetAllBeds() {
            if(!confirm("Reset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
            const homePos = { bed01:{x:20,y:25,d:0}, bed02:{x:75,y:25,d:0}, bed03:{x:130,y:25,d:0} };
            const homeStatus = { bed01:'station', bed02:'station', bed03:'station' };
            await db.ref('beds').set(homePos);
            await db.ref('commands/bedStatus').set(homeStatus);
            await db.ref('fleet').set({ A1:false, A2:false, A4:false, A5:false, room101:false });
            db.ref('commands/emergency').set(false);
            addLog("üîÑ SYSTEM REBOOTED");
        }

        function move(id, x, y, deg) {
            return new Promise(resolve => {
                if (isEmergency) return;
                db.ref(`beds/${id}`).update({ x: x, y: y, d: deg });
                setTimeout(resolve, 1500);
            });
        }

        function updateBedUI(id) {
            const el = document.getElementById(id);
            if(el) {
                el.style.left = currentPos[id].x + 'px';
                el.style.top = currentPos[id].y + 'px';
                el.style.transform = `rotate(${currentPos[id].d}deg)`;
            }
        }

     async function executePath() {
    if (isEmergency) return;
    const id = document.getElementById('bedSelect').value;
    const dest = document.getElementById('destLoc').value;
    const start = currentStatus[id] || 'station';

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    if (start === dest) {
        alert(`‡πÄ‡∏ï‡∏µ‡∏¢‡∏á ${id} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${dest} ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö`);
        return;
    }
    if (dest !== 'station' && slotOccupancy[dest]) {
        alert("‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏≠‡∏∑‡πà‡∏ô"); 
        return;
    }

    addLog(`üöÄ ${id} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà: ${start} -> ${dest}`);
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô Firebase
    if (start !== 'station') db.ref(`fleet/${start}`).set(false);

    // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô (Nodes)
    const MAIN_V_LINE = 258; // ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏Å
    const MAIN_H_LINE = 320; // ‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏¢‡∏Å)
    const slotX = { A1: 425, A2: 675, A4: 425, A5: 675 };

    // --- CASE A: ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î (A1, A2, A4, A5, Room101) ---
    if (dest !== 'station') {
        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Station ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡πâ‡∏á
        await move(id, currentPos[id].x, 215, 180); 
        await move(id, MAIN_V_LINE, 215, 90); 

        if (dest === 'room101') {
            await move(id, MAIN_V_LINE, 445, 180); 
            await move(id, 55, 445, 270); 
        } 
        else {
            // ‡πÑ‡∏õ Slot A ‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô)
            await move(id, MAIN_V_LINE, MAIN_H_LINE, 180); 
            await move(id, slotX[dest], MAIN_H_LINE, 90); 
            
            if (dest === 'A1' || dest === 'A2') {
                await move(id, slotX[dest], 450, 180); // ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á
            } else {
                await move(id, slotX[dest], 100, 0);   // ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏≠‡∏á‡∏ö‡∏ô
            }
        }
    } 
    // --- CASE B: ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö STATION ---
    else {
        if (start === 'room101') {
            await move(id, MAIN_V_LINE, 445, 90);
        } 
        else if (start.startsWith('A')) {
            // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ã‡∏≠‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô‡∏ô‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            const exitY = (start === 'A1' || start === 'A2') ? MAIN_H_LINE : MAIN_H_LINE;
            await move(id, slotX[start], MAIN_H_LINE, (start === 'A1' || start === 'A2') ? 0 : 180);
            await move(id, MAIN_V_LINE, MAIN_H_LINE, 270); // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏Å
        }
        
        // ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Station
        await move(id, MAIN_V_LINE, 215, 0); // ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
        await move(id, 80, 215, 270);        // ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ
        
        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        const homeX = id === 'bed01' ? 30 : id === 'bed02' ? 85 : 140;
        await move(id, homeX, 40, 0); // ‡∏à‡∏≠‡∏î‡∏ô‡∏¥‡πà‡∏á‡πÜ ‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö
    }

    // --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ---
    currentStatus[id] = dest;
    db.ref('commands/bedStatus').update({ [id]: dest }); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏±‡∏ô
    if (dest !== 'station') db.ref(`fleet/${dest}`).set(true);
    addLog(`üìç ${id} ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢ ${dest} ‡πÅ‡∏•‡πâ‡∏ß`);
}
    </script>
</body>
</html>